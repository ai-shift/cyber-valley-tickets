# Django Migration Recreation Plan

## Problem Summary

The Django backend has broken migrations:

1. **Missing migration chain in `events` app**: Migration `0017_ticketcategory_has_quota.py` exists but depends on `0016`, which is missing (along with `0014` and `0015`)
2. **Orphaned migration**: `0017` references a `TicketCategory` model that doesn't exist in `events/models.py`
3. **Data migration complexity**: Migration `0013` contains a data migration that converts geometry coordinates format

## Current State

### Migration Files by App:
- `events`: 0001-0013, 0017 (missing 0014, 0015, 0016)
- `users`: 0001-0008
- `indexer`: 0001-0005
- `custom_auth`: 0001-0002
- `notifications`: 0001-0002
- `shaman_verification`: 0001-0004
- `geodata`: 0001
- `scripts`: __init__.py only

### Database Configuration:
- Debug: SQLite3 (`db.sqlite3`)
- Production: PostgreSQL (via env vars)

## Proposed Solution

Since the project is in development, we'll completely recreate migrations:

### Step 1: Backup and Reset
1. Backup existing database (if needed)
2. Delete all migration files (except `__init__.py`)
3. Delete the database file (`db.sqlite3`)

### Step 2: Recreate Migrations
1. Run `makemigrations` for all apps to create fresh initial migrations
2. Verify migrations are created correctly

### Step 3: Apply Migrations
1. Run `migrate` to apply all fresh migrations
2. Verify database schema matches models

### Step 4: Verification
1. Run Django checks: `python manage.py check`
2. Run tests if available
3. Verify admin interface works

## Critical Files

### To Delete:
- `/home/user/code/aishift/tickets/backend/cyber_valley/events/migrations/0001_initial.py` through `0013_*.py`
- `/home/user/code/aishift/tickets/backend/cyber_valley/events/migrations/0017_ticketcategory_has_quota.py`
- `/home/user/code/aishift/tickets/backend/cyber_valley/users/migrations/0001_initial.py` through `0008_*.py`
- `/home/user/code/aishift/tickets/backend/cyber_valley/indexer/migrations/0001_initial.py` through `0005_*.py`
- `/home/user/code/aishift/tickets/backend/cyber_valley/custom_auth/migrations/0001_initial.py` through `0002_*.py`
- `/home/user/code/aishift/tickets/backend/cyber_valley/notifications/migrations/0001_initial.py` through `0002_*.py`
- `/home/user/code/aishift/tickets/backend/cyber_valley/shaman_verification/migrations/0001_initial.py` through `0004_*.py`
- `/home/user/code/aishift/tickets/backend/cyber_valley/geodata/migrations/0001_initial.py`
- `/home/user/code/aishift/tickets/backend/db.sqlite3`

### To Keep:
- All `__init__.py` files in migration directories

### Commands to Run:
```bash
cd /home/user/code/aishift/tickets/backend

# Step 1: Delete all migration files (keep __init__.py)
find cyber_valley -path "*/migrations/*.py" -not -name "__init__.py" -delete

# Step 2: Delete database
rm -f db.sqlite3

# Step 3: Create fresh migrations
uv run python manage.py makemigrations

# Step 4: Apply migrations
uv run python manage.py migrate

# Step 5: Verify
uv run python manage.py check
```

## Verification Steps

1. **Check migrations created**: Verify `0001_initial.py` files exist for all apps with models
2. **Run Django system checks**: Ensure no errors
3. **Test admin interface**: Access Django admin to verify models load
4. **Run existing tests**: `make tests` or `uv run pytest`

## Notes

- **Data loss**: Since we're deleting the database, all existing data will be lost. This is acceptable for a development project.
- **Data migration loss**: The geometry coordinate conversion in `0013` will be lost. If this data format is still needed, it should be handled at the application level or via a new data migration after recreation.
- **TicketCategory model**: The orphaned `0017` migration references a non-existent model. This confirms the model was removed but migration wasn't cleaned up.
