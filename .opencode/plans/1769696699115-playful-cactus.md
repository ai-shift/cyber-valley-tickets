# Revenue Splitter Implementation Plan

## Current Status

### Completed
- ✅ Smart contracts (DynamicRevenueSplitter.sol, IDynamicRevenueSplitter.sol)
- ✅ Contract tests (DynamicRevenueSplitter.test.ts)
- ✅ EventManager integration (setRevenueSplitter, distributeEventFunds)
- ✅ Backend indexer events (DynamicRevenueSplitter.py)
- ✅ Revenue distribution notifications (_sync_revenue_distributed)
- ✅ Event model has total_revenue field

### Missing/Partial
- ❌ Backend: Update total_revenue when tickets are minted
- ❌ Backend: API endpoint for lifetime revenue
- ❌ Backend: Revenue data in event serializers
- ❌ Frontend: Revenue display components
- ❌ Frontend: "Lifetime Revenue" button on Events screen

## Implementation Plan

### Phase 1: Backend Revenue Tracking

#### 1.1 Update _sync_ticket_minted to track revenue
**File:** `backend/cyber_valley/indexer/service/_sync.py`
- Modify `_sync_ticket_minted()` to increment `event.total_revenue`
- Need to get the actual ticket price paid (may need to parse from transaction or store in Ticket model)
- Update logic around line 311

#### 1.2 Add API endpoint for lifetime revenue
**File:** `backend/cyber_valley/events/views.py`
- Add new endpoint: `GET /api/events/{id}/lifetime_revenue/`
- Returns total revenue for the event
- Should be accessible to event creator and staff

#### 1.3 Update serializers to include revenue
**File:** `backend/cyber_valley/events/serializers.py`
- Add `total_revenue` field to EventSerializer
- Add `paid_deposit` field to expose deposit information
- Consider adding revenue breakdown (tickets vs deposit)

#### 1.4 Update URL routing
**File:** `backend/cyber_valley/urls.py`
- Add route for the new lifetime_revenue endpoint

### Phase 2: Frontend Revenue Display

#### 2.1 Create revenue API hooks
**File:** New file `client/src/shared/api/hooks/useRevenue.ts`
- Create hook to fetch lifetime revenue for an event
- Use React Query for caching

#### 2.2 Create LifetimeRevenueButton component
**File:** New file `client/src/features/events/components/LifetimeRevenueButton.tsx`
- Display button on Events screen (top right as per requirements)
- Show total earnings in USDT
- Style according to design system

#### 2.3 Create RevenueDisplay component
**File:** New file `client/src/features/events/components/RevenueDisplay.tsx`
- Show detailed revenue breakdown
- Display total revenue, ticket count, average price
- Show deposit amount separately

#### 2.4 Update Event page
**File:** `client/src/features/events/pages/EventPage.tsx` (or similar)
- Add LifetimeRevenueButton to the header
- Integrate RevenueDisplay component

#### 2.5 Update API types
**File:** `client/src/shared/api/apiTypes.d.ts`
- Add total_revenue field to Event type
- Add lifetime_revenue endpoint type

### Phase 3: Testing & Verification

#### 3.1 Backend tests
- Test revenue tracking when tickets are minted
- Test lifetime_revenue API endpoint
- Test serializer includes revenue fields

#### 3.2 Frontend tests
- Test LifetimeRevenueButton renders correctly
- Test RevenueDisplay shows correct data
- Test API integration

#### 3.3 Integration testing
- End-to-end test: Create event → Buy tickets → Check revenue
- Verify revenue matches expected calculations

## Critical Files to Modify

### Backend
1. `backend/cyber_valley/indexer/service/_sync.py` - Add revenue tracking
2. `backend/cyber_valley/events/views.py` - Add lifetime_revenue endpoint
3. `backend/cyber_valley/events/serializers.py` - Add revenue fields
4. `backend/cyber_valley/urls.py` - Add URL route

### Frontend
1. `client/src/shared/api/hooks/useRevenue.ts` - New API hook
2. `client/src/features/events/components/LifetimeRevenueButton.tsx` - New component
3. `client/src/features/events/components/RevenueDisplay.tsx` - New component
4. `client/src/shared/api/apiTypes.d.ts` - Update types
5. Event page component - Add revenue UI

## Verification Steps

1. **Contract Level:**
   - Run `cd ethereum && make tests` - All tests should pass
   - Verify closeEvent distributes funds correctly

2. **Backend Level:**
   - Buy a ticket through the contract
   - Verify indexer updates `total_revenue` in database
   - Call `/api/events/{id}/lifetime_revenue/` - Should return correct amount

3. **Frontend Level:**
   - Navigate to event page
   - Verify "Lifetime Revenue" button displays
   - Click button - should show correct revenue amount
   - Revenue should update when new tickets are bought

4. **Integration:**
   - Create event → Buy 3 tickets @ 10 USDT each
   - Verify total_revenue = 30 USDT + deposit
   - Close event → Verify distribution notification sent

## Estimated Time

- Phase 1 (Backend): 2-3 hours
- Phase 2 (Frontend): 3-4 hours
- Phase 3 (Testing): 1-2 hours
- **Total: 6-9 hours**